<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Inventory Management</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<style>
		body {
			font-family: Arial, sans-serif;
		}
		.card {
			margin-bottom: 20px;
		}
		.card-header {
			background-color: #563D2D;
			color: white;
			font-size: 1.25rem;
		}
		.card-body {
			padding: 20px;
		}
		table {
			width: 100%;
		}
		th, td {
			text-align: center;
			padding: 8px;
		}
		th {
			background-color: #f2f2f2;
		}
		.table-container {
			overflow-x: auto;
		}
		#exportButton {
		    background-color: #3B5323; /* Dark matte green */
		    color: white;
		    border-color: #3B5323; /* Match the border color */
		}

		#exportButton:hover {
		    background-color: #334D23; /* Slightly darker shade on hover */
		    border-color: #334D23; /* Match the border color on hover */
		}
		.btn-custom {
		    background-color: rgb(170, 130, 115); /* Lighter RGB color */
		    border: none;
		    color: white; /* White text color */
		    padding: 10px 20px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		    font-size: 16px;
		    margin: 4px 2px;
		    cursor: pointer;
		    border-radius: 5px; /* Optional: for rounded corners */
		}

		.btn-custom:hover {
		    background-color: rgb(150, 110, 95); /* Slightly darker color on hover for better user experience */
		}


	</style>
</head>
<body>
<div class="container">
	<h1 class="my-4">D'Baesics Inventory Management</h1>

	<!-- Month Selector -->
	<div class="card mb-4">
		<div class="card-header">
			<h2>Select Month</h2>
		</div>
		<div class="card-body">
			<div class="form-group">
				<label for="monthSelect">Month</label>
				<select class="form-control" id="monthSelect">
					<option value="">Select Month</option>
					<option value="all">All Months</option>
					<!-- Options will be added dynamically -->
				</select>
			</div>
		</div>
	</div>


	<!-- Product Selector -->
	<div class="card mb-4">
		<div class="card-header">
			<h2>Select Product</h2>
		</div>
		<div class="card-body">
			<div class="form-group">
				<label for="productSelect">Product</label>
				<select class="form-control" id="productSelect" required>
					<option value="" disabled selected>Select Product</option>
					<!-- Options will be populated dynamically -->
				</select>
			</div>
		</div>
	</div>

	<!-- Inventory Form -->
	<div class="card mb-4" id="inventoryFormCard" style="display: none;">
		<div class="card-header">
			<h2>Inventory Entry</h2>
		</div>
		<div class="card-body">
			<form id="inventoryForm" method="post" action="/inventory/add">
				<div class="form-group">
					<label for="productSelect">Product</label>
					<input type="hidden" id="productName" name="productName">
					<!-- The product select will remain unchanged -->
				</div>
				<div class="form-group">
					<label for="entryDate">Date</label>
					<input type="date" class="form-control" id="entryDate" name="entryDate" required>
				</div>
				<div class="form-group">
					<label for="description">Description</label>
					<select class="form-control" id="description" name="description" required>
						<option value="" disabled selected>Select Description</option>
						<option value="Purchase of Inventory">Purchase of Inventory</option>
						<option value="Sale of Merchandise">Sale of Merchandise</option>
					</select>
				</div>
				<div class="form-group">
					<label for="cost">Cost</label>
					<input type="number" class="form-control" id="cost" name="cost" required readonly>
				</div>
				<div class="form-group">
					<label for="quantity">Quantity</label>
					<input type="number" class="form-control" id="quantity" name="quantity" required>
				</div>
				<div class="form-group">
					<label for="currentBalance">Current Balance</label>
					<input type="text" class="form-control" id="currentBalance" name="currentBalance" readonly>
				</div>
				<button type="submit" class="btn-custom">Add Entry</button>
			</form>
		</div>
	</div>

	<!-- Inventory Tables -->
	<div id="inventoryTables">
		<!-- Tables will be added dynamically here -->
	</div>

	<!-- Export Button -->
	<div class="card">
		<div class="card-body">
			<button id="exportButton" class="btn btn-success mt-4">Export to Excel</button>
		</div>
	</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script>
	const inventoryData = {};
	const productSelect = document.getElementById('productSelect');
	const inventoryFormCard = document.getElementById('inventoryFormCard');
	const inventoryTables = document.getElementById('inventoryTables');
	const exportButton = document.getElementById('exportButton');
	const costInput = document.getElementById('cost');
	const currentBalanceInput = document.getElementById('currentBalance');
	const monthSelect = document.getElementById('monthSelect'); // New dropdown for month selection
	let currentProduct = '';
	let selectedMonth = '';

	// Fetch and populate month options
	function populateMonthOptions() {
	    fetch('/inventory/months')
	        .then(response => response.json())
	        .then(months => {
	            const monthSelect = document.getElementById('monthSelect');
	            months.forEach(month => {
	                const option = document.createElement('option');
	                option.value = month;
	                option.textContent = new Date(month + '-01').toLocaleString('default', { month: 'long', year: 'numeric' });
	                monthSelect.appendChild(option);
	            });
	        })
	        .catch(error => console.error('Error fetching months:', error));
	}

	// Call this function when the page loads
	document.addEventListener('DOMContentLoaded', populateMonthOptions);


	// Fetch products and populate the product selector
	fetch('/products')
		.then(response => response.json())
		.then(products => {
			productSelect.innerHTML = '<option value="" disabled selected>Select Product</option>';
			products.forEach(product => {
				const option = document.createElement('option');
				option.value = product.name;
				option.textContent = product.name;
				productSelect.appendChild(option);
			});
		})
		.catch(error => console.error('Error fetching products:', error));

	// Fetch the cost of the selected product
	function fetchProductCost(productName) {
		fetch(`/products/${productName}/cost`)
			.then(response => response.json())
			.then(data => costInput.value = data || '')
			.catch(error => console.error('Error fetching product cost:', error));
	}

	// Fetch the latest balance for the selected product
	function fetchLatestBalance(productName) {
		return fetch(`/inventory/latest-balance?productName=${encodeURIComponent(productName)}`)
			.then(response => response.json())
			.then(data => data.latestBalance || 0)
			.catch(error => console.error('Error fetching latest balance:', error));
	}

	// Handle month selection
	monthSelect.addEventListener('change', function() {
	    selectedMonth = monthSelect.value;
	    updateTables();
	});


	// Handle product selection
	productSelect.addEventListener('change', function() {
	    currentProduct = productSelect.value;
	    document.getElementById('productName').value = currentProduct;
	    inventoryFormCard.style.display = 'block';
	    fetchProductCost(currentProduct);
	    fetchLatestBalance(currentProduct).then(latestBalance => {
	        currentBalanceInput.value = (latestBalance <= 0 || latestBalance === undefined) ? 'Out of Stock!' : latestBalance.toFixed(2);
	        inventoryData[currentProduct] = inventoryData[currentProduct] || [];
	        if (inventoryData[currentProduct].length > 0) {
	            inventoryData[currentProduct][inventoryData[currentProduct].length - 1].balance = latestBalance;
	        }
	        updateTables();
	    });
	});


	// Handle month selection
	monthSelect.addEventListener('change', function() {
		selectedMonth = monthSelect.value;
		updateTables();
	});

	// Handle inventory form submission
	document.getElementById('inventoryForm').addEventListener('submit', function(event) {
		event.preventDefault();
		const date = document.getElementById('entryDate').value;
		const description = document.getElementById('description').value;
		const cost = parseFloat(costInput.value);
		const quantity = parseInt(document.getElementById('quantity').value);

		let inAmount = 0;
		let outAmount = 0;
		let currentBalance = 0;

		fetchLatestBalance(currentProduct).then(latestBalance => {
			currentBalance = latestBalance;

			if (description === 'Purchase of Inventory') {
				inAmount = cost * quantity;
				currentBalance += inAmount;
			} else if (description === 'Sale of Merchandise') {
				outAmount = cost * quantity;
				currentBalance -= outAmount;
			}

			const entry = {
				productName: currentProduct,
				entryDate: date,
				description: description,
				cost: cost,
				quantity: quantity,
				inAmount: inAmount,
				outAmount: outAmount,
				balance: currentBalance,
				remarks: '' // Add any remarks if needed
			};

			if (!inventoryData[currentProduct]) {
				inventoryData[currentProduct] = [];
			}
			inventoryData[currentProduct].push(entry);

			// Save entry to server
			fetch('/inventory/add', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(entry)
			})
			.then(response => response.json())
			.then(data => {
				entry.id = data.id; // Update entry with ID
				fetchLatestBalance(currentProduct).then(latestBalance => {
					currentBalanceInput.value = (latestBalance <= 0 || latestBalance === undefined) ? 'Out of Stock!' : latestBalance.toFixed(2);
					updateTables();
				});
			})
			.catch(error => console.error('Error saving entry:', error));
		});
	});

	// Handle update Tables ajax
	// Filter entries by product and month, then update the tables
	function updateTables() {
	    if (!currentProduct) {
	        return;
	    }

	    fetch(`/inventory/entries?productName=${encodeURIComponent(currentProduct)}&month=${encodeURIComponent(selectedMonth)}`)
	        .then(response => response.json())
	        .then(entries => {
	            inventoryTables.innerHTML = ''; // Clear existing tables
	            const groupedEntries = entries.reduce((acc, entry) => {
	                const date = entry.entryDate.split('T')[0]; // Assuming entryDate is in ISO format
	                if (!acc[date]) acc[date] = [];
	                acc[date].push(entry);
	                return acc;
	            }, {});

	            Object.keys(groupedEntries).forEach(date => {
	                const table = document.createElement('table');
	                table.className = 'table table-bordered table-striped';
	                const thead = document.createElement('thead');
	                thead.innerHTML = `
	                    <tr>
	                        <th>ID</th>
	                        <th>Product Name</th>
	                        <th>Date</th>
	                        <th>Description</th>
	                        <th>Cost</th>
	                        <th>Quantity</th>
	                        <th>In Amount</th>
	                        <th>Out Amount</th>
	                        <th>Balance</th>
	                        <th>Remarks</th>
	                    </tr>
	                `;
	                table.appendChild(thead);

	                const tbody = document.createElement('tbody');
	                groupedEntries[date].forEach(entry => {
	                    const tr = document.createElement('tr');
	                    tr.innerHTML = `
	                        <td>${entry.id}</td>
	                        <td>${entry.productName}</td>
	                        <td>${entry.entryDate}</td>
	                        <td>${entry.description}</td>
	                        <td>${entry.cost}</td>
	                        <td>${entry.quantity}</td>
	                        <td>${entry.inAmount}</td>
	                        <td>${entry.outAmount}</td>
	                        <td>${entry.balance}</td>
	                        <td>${entry.remarks}</td>
	                    `;
	                    tbody.appendChild(tr);
	                });
	                table.appendChild(tbody);
	                inventoryTables.appendChild(table);
	            });
	        })
	        .catch(error => console.error('Error fetching inventory entries:', error));
	}


	// delete entry for delete button
	function deleteEntry(entryId) {
		if (confirm('Are you sure you want to delete this entry?')) {
			fetch(`/inventory/delete/${entryId}`, {
				method: 'DELETE',
			})
			.then(response => response.json())
			.then(() => {
				updateTables();
			})
			.catch(error => console.error('Error deleting entry:', error));
		}
	}

	// Handle export to Excel
	exportButton.addEventListener('click', function() {
		window.location.href = '/document/export';
	});
</script>
</body>
</html>
